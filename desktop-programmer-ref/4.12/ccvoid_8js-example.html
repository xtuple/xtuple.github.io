<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title> ccvoid.js</title>
<link href="xtuple_doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="jquery.js"></script>
</head><body>
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ccvoid.js</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This file is part of the xTuple ERP application suite,</span></div>
<div class="line"><span class="comment"> * and is Copyright (c) 1999-2019 by OpenMFG LLC, d/b/a xTuple.  It</span></div>
<div class="line"><span class="comment"> * is licensed to you under the xTuple End-User License Agreement (&quot;the</span></div>
<div class="line"><span class="comment"> * EULA&quot;), the full text of which is available at www.xtuple.com/EULA.</span></div>
<div class="line"><span class="comment"> * While the EULA gives you access to source code and encourages your</span></div>
<div class="line"><span class="comment"> * involvement in the development process, this Package is not free</span></div>
<div class="line"><span class="comment"> * software.  By using this software, you agree to be bound by the</span></div>
<div class="line"><span class="comment"> * terms of the EULA.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* a completely scripted implementation of voiding previously-created</span></div>
<div class="line"><span class="comment">   credit card transactions through authorize.net. the window</span></div>
<div class="line"><span class="comment">   contains a list of transactions available to void, a button to</span></div>
<div class="line"><span class="comment">   void the currently-selected transaction, and a close button.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line">var _ccp    = toolbox.getCreditCardProcessor();</div>
<div class="line"><span class="keywordflow">if</span> (_ccp == <span class="keyword">null</span>)</div>
<div class="line">  QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;No Credit Card Processor&quot;</span>),</div>
<div class="line">                       qsTr(<span class="stringliteral">&quot;Could not get a credit card processor&quot;</span>));</div>
<div class="line">var _currid = -1;</div>
<div class="line">var _transactions = mywindow.findChild(<span class="stringliteral">&quot;_transactions&quot;</span>);</div>
<div class="line">var _void         = mywindow.findChild(<span class="stringliteral">&quot;_void&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// with authorize.net, the CCServer is really a full url except for the port</span></div>
<div class="line">var _url = <span class="keyword">new</span> QUrl(metrics.value(<span class="stringliteral">&quot;CCServer&quot;</span>));</div>
<div class="line"><span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCPort&quot;</span>) &gt; 0)</div>
<div class="line">   _url.setPort(metrics.value(<span class="stringliteral">&quot;CCPort&quot;</span>));</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">   _url.setPort(_ccp.defaultPort());</div>
<div class="line"> </div>
<div class="line">var _netmgr = <span class="keyword">new</span> QNetworkAccessManager(mywindow);</div>
<div class="line">var _netreply;</div>
<div class="line"> </div>
<div class="line">var _error = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// network requests are asynchronous; let sHandleResponse deal with the reply when it comes</span></div>
<div class="line">_netmgr.authenticationRequired.connect(sHandleAuthenticationRequired);</div>
<div class="line">_netmgr.proxyAuthenticationRequired.connect(sHandleProxyAuthenticationRequired);</div>
<div class="line">_netmgr.sslErrors.connect(sHandleSslError);</div>
<div class="line"> </div>
<div class="line">_netmgr.finished.connect(sHandleResponse);</div>
<div class="line">_void.clicked.connect(sVoid);</div>
<div class="line"> </div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Cust. #&quot;</span>,     -1, Qt.AlignLeft,  <span class="keyword">true</span>, <span class="stringliteral">&quot;cust_number&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Name&quot;</span>,        -1, Qt.AlignLeft,  <span class="keyword">true</span>, <span class="stringliteral">&quot;cust_name&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Type&quot;</span>,        -1, Qt.AlignLeft,  <span class="keyword">true</span>, <span class="stringliteral">&quot;type&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Transaction&quot;</span>, -1, Qt.AlignLeft,  <span class="keyword">true</span>, <span class="stringliteral">&quot;status&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Order-Seq.&quot;</span>,  -1, Qt.AlignRight, <span class="keyword">true</span>, <span class="stringliteral">&quot;docnumber&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Amount&quot;</span>,      -1, Qt.AlignRight, <span class="keyword">true</span>, <span class="stringliteral">&quot;ccpay_amount&quot;</span>);</div>
<div class="line">_transactions.addColumn(<span class="stringliteral">&quot;Currency&quot;</span>,    -1, Qt.AlignLeft,  <span class="keyword">true</span>, <span class="stringliteral">&quot;currAbbr&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sHandleAuthenticationRequired(reply, authenticator)</div>
<div class="line">{</div>
<div class="line">  print(<span class="stringliteral">&quot;sHandleAuthenticationRequired called&quot;</span>);</div>
<div class="line">  toolbox.listProperties(reply);</div>
<div class="line">  toolbox.listProperties(authenticator);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sHandleProxyAuthenticationRequired(proxy, authenticator)</div>
<div class="line">{</div>
<div class="line">  print(<span class="stringliteral">&quot;sHandleProxyAuthenticationRequired called&quot;</span>);</div>
<div class="line">  toolbox.listProperties(proxy);</div>
<div class="line">  toolbox.listProperties(authenticator);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sHandleSslError(reply, errors)</div>
<div class="line">{</div>
<div class="line">  print(<span class="stringliteral">&quot;sHandleSslError called&quot;</span>);</div>
<div class="line">  toolbox.listProperties(reply);</div>
<div class="line">  toolbox.listProperties(errors);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sPopulateTransactions()</div>
<div class="line">{</div>
<div class="line">  var params = <span class="keyword">new</span> Object;</div>
<div class="line"> </div>
<div class="line">  params.preauth        = <span class="stringliteral">&quot;Preauthorization&quot;</span>;</div>
<div class="line">  params.charge         = <span class="stringliteral">&quot;Charge&quot;</span>;</div>
<div class="line">  params.refund         = <span class="stringliteral">&quot;Refund/Credit&quot;</span>;</div>
<div class="line">  params.authorized     = <span class="stringliteral">&quot;Authorized&quot;</span>;</div>
<div class="line">  params.approved       = <span class="stringliteral">&quot;Approved&quot;</span>;</div>
<div class="line">  params.declined       = <span class="stringliteral">&quot;Declined/Denied&quot;</span>;</div>
<div class="line">  params.voided         = <span class="stringliteral">&quot;Voided&quot;</span>;</div>
<div class="line">  params.noapproval     = <span class="stringliteral">&quot;Not Approved&quot;</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCValidDays&quot;</span>) &gt; 0)</div>
<div class="line">    params.ccValidDays  = metrics.value(<span class="stringliteral">&quot;CCValidDays&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    params.ccValidDays  = 7;</div>
<div class="line"> </div>
<div class="line">  _transactions.populate(toolbox.executeDbQuery(<span class="stringliteral">&quot;ccpayments&quot;</span>, <span class="stringliteral">&quot;list&quot;</span>, params));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convenience function to help build the message to send</span></div>
<div class="line"><span class="keyword">function</span> APPENDFIELD(request, name, content)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (request != <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line">    request = request + <span class="stringliteral">&quot;&amp;&quot;</span>;</div>
<div class="line">  <span class="keywordflow">return</span> request + name + <span class="stringliteral">&quot;=&quot;</span> + content;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* this was translated from the C++ sources</span></div>
<div class="line"><span class="comment">   authorizedotnetprocessor.cpp and creditcardprocessor.cpp</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">function</span> sVoid()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    <span class="comment">// local error checks</span></div>
<div class="line">    <span class="keywordflow">if</span> (_transactions.currentItem().text(<span class="stringliteral">&quot;status&quot;</span>) == <span class="stringliteral">&quot;Voided&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.warning(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),</div>
<div class="line">                          qsTr(<span class="stringliteral">&quot;This transaction cannot be voided a second time.&quot;</span>));</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// build the message</span></div>
<div class="line">    var params = <span class="keyword">new</span> Object;</div>
<div class="line">    params.ccpayid = _transactions.id();</div>
<div class="line">    params.key     = mainwindow.key;</div>
<div class="line">    var anq = toolbox.executeQuery(</div>
<div class="line">          <span class="stringliteral">&quot;SELECT ccard_active,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_number),   setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;))   AS ccard_number,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatccnumber(decrypt(setbytea(ccard_number),setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_number_x,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_name),     setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_name,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_address1), setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_address1,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_address2), setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_address2,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_city),     setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_city,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_state),    setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_state,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_zip),      setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_zip,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_country),  setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_country,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_month_expired),setbytea(&lt;? value(&#39;key&#39; ?&gt;),&#39;bf&#39;)) AS ccard_month_expired,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_year_expired),setbytea(&lt;? value(&#39;key&#39; ?&gt;), &#39;bf&#39;)) AS ccard_year_expired,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  custinfo.*,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  ccpay.*,&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  curr_symbol.*&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  FROM ccard &quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  JOIN custinfo ON (ccard_cust_id=cust_id)&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  JOIN ccpay    ON (ccard_id=ccpay_ccard_id)&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;  JOIN curr_symbol ON (curr_id=ccpay_curr_id)&quot;</span></div>
<div class="line">        + <span class="stringliteral">&quot;WHERE (ccpay_id=&lt;? value(&#39;ccpayid&#39;) ?&gt;);&quot;</span>,</div>
<div class="line">          params);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (anq.first())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (! anq.value(<span class="stringliteral">&quot;ccard_active&quot;</span>))</div>
<div class="line">      {</div>
<div class="line">        QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),</div>
<div class="line">                             _ccp.errorMsg(-10).replace(<span class="stringliteral">&quot;%1&quot;</span>, anq.value(<span class="stringliteral">&quot;ccard_number_x&quot;</span>)));</div>
<div class="line">        <span class="keywordflow">return</span> -10;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (anq.lastError().type != 0)</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),</div>
<div class="line">                           qsTr(<span class="stringliteral">&quot;A database error occurred: %1&quot;</span>).arg(anq.lastError().text));</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>), _ccp.errorMsg(-17));</div>
<div class="line">      <span class="keywordflow">return</span> -17;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    var prequest = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    _currid = anq.value(<span class="stringliteral">&quot;ccpay_curr_id&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>).length &gt; 0)</div>
<div class="line">      prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_delim_char&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_version&quot;</span>,      metrics.value(<span class="stringliteral">&quot;CCANVer&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_delim_data&quot;</span>, <span class="stringliteral">&quot;TRUE&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCANEncap&quot;</span>).length &gt; 0)</div>
<div class="line">      prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_encap_char&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANEncap&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_login&quot;</span>,    metricsenc.value(<span class="stringliteral">&quot;CCLogin&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_tran_key&quot;</span>, metricsenc.value(<span class="stringliteral">&quot;CCPassword&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_amount&quot;</span>,   _transactions.column(<span class="stringliteral">&quot;ccpay_amount&quot;</span>).text);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_card_num&quot;</span>, anq.value(<span class="stringliteral">&quot;ccard_number&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_test_request&quot;</span>, _ccp.isLive() ? <span class="stringliteral">&quot;FALSE&quot;</span> : <span class="stringliteral">&quot;TRUE&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    var work_month = anq.value(<span class="stringliteral">&quot;ccard_month_expired&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (work_month &lt; 10 &amp;&amp; work_month &gt; 0)</div>
<div class="line">      work_month = <span class="stringliteral">&quot;0&quot;</span> + work_month;</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_exp_date&quot;</span>,</div>
<div class="line">                           work_month + anq.value(<span class="stringliteral">&quot;ccard_year_expired&quot;</span>) % 100);</div>
<div class="line"> </div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_relay_response&quot;</span>, <span class="stringliteral">&quot;FALSE&quot;</span>);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_duplicate_window&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANDuplicateWindow&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    var name = anq.value(<span class="stringliteral">&quot;ccard_name&quot;</span>).split(/\s+/);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_first_name&quot;</span>, name[0]);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_last_name&quot;</span>,  name[name.length - 1]);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_company&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_name&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_address&quot;</span>,    anq.value(<span class="stringliteral">&quot;ccard_address1&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_city&quot;</span>,       anq.value(<span class="stringliteral">&quot;ccard_city&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_state&quot;</span>,      anq.value(<span class="stringliteral">&quot;ccard_state&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_zip&quot;</span>,        anq.value(<span class="stringliteral">&quot;ccard_zip&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_country&quot;</span>,    anq.value(<span class="stringliteral">&quot;ccard_country&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (metrics.CCANWellsFargoSecureSource)</div>
<div class="line">    {</div>
<div class="line">      prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_phone&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_phone&quot;</span>));</div>
<div class="line">      prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_email&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_email&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_currency_code&quot;</span>, anq.value(<span class="stringliteral">&quot;curr_abbr&quot;</span>));</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_method&quot;</span>,        <span class="stringliteral">&quot;CC&quot;</span>);</div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_type&quot;</span>,          <span class="stringliteral">&quot;VOID&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    prequest = APPENDFIELD(prequest, <span class="stringliteral">&quot;x_trans_id&quot;</span>,</div>
<div class="line">                           _ccp.isLive() ? anq.value(<span class="stringliteral">&quot;ccpay_r_ordernum&quot;</span>) : 12345);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// post is asynchronous. while we&#39;re waiting, lock out the user so s/he doesn&#39;t try again</span></div>
<div class="line">    _transactions.enabled = <span class="keyword">false</span>;</div>
<div class="line">    _void.enabled         = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    var netreq = <span class="keyword">new</span> QNetworkRequest();</div>
<div class="line">    netreq.setUrl(_url);</div>
<div class="line"> </div>
<div class="line">    _netreply = _netmgr.post(netreq, prequest);</div>
<div class="line">    _netreply.error.connect(sError);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> (e)</div>
<div class="line">  {</div>
<div class="line">    print(<span class="stringliteral">&quot;sVoid exception at &quot;</span> + e.lineNumber + <span class="stringliteral">&quot;: &quot;</span> + e);</div>
<div class="line">    _transactions.enabled = <span class="keyword">true</span>;</div>
<div class="line">    _void.enabled         = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sHandleResponse(netresponse)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">  {</div>
<div class="line">    print(<span class="stringliteral">&quot;sHandleResponse entered&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (_error)</div>
<div class="line">    {</div>
<div class="line">      _error = <span class="keyword">false</span>;</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// parse the reply, which is a QVariant(QByteArray) so first grab it as a string</span></div>
<div class="line">    var response = netresponse.readAll().toString();</div>
<div class="line">    <span class="keywordflow">if</span> (response.match(/^&lt;HTML&gt;/i))</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error returned from A.N&quot;</span>),</div>
<div class="line">                         response);</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// field[N] here corresponds to fieldValue(..., N+1, ...) in the C++.</span></div>
<div class="line">    <span class="comment">// Authorize.Net uses 1-based arrays, JavaScript uses 0-based arrays, and</span></div>
<div class="line">    <span class="comment">// C++ uses 0-based arrays but the C++ function fieldValue translates</span></div>
<div class="line">    var field = response.split(metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>).length &gt; 0 ?</div>
<div class="line">                                        metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>) : <span class="stringliteral">&quot;,&quot;</span>);</div>
<div class="line">    var params = <span class="keyword">new</span> Object;</div>
<div class="line">  </div>
<div class="line">    <span class="keywordflow">if</span> (field[0] == 2)</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Declined&quot;</span>),</div>
<div class="line">                           qsTr(<span class="stringliteral">&quot;The void transaction was declined&quot;</span>));</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 3)</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error&quot;</span>),</div>
<div class="line">                         qsTr(<span class="stringliteral">&quot;The void transaction received an error: %1&quot;</span>)</div>
<div class="line">                         .arg(field[3]));</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 1)</div>
<div class="line">      params.approved = <span class="stringliteral">&quot;APPROVED&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 4)</div>
<div class="line">      params.approved = <span class="stringliteral">&quot;HELDFORREVIEW&quot;</span>;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error&quot;</span>),</div>
<div class="line">                           qsTr(<span class="stringliteral">&quot;The void transaction received an unknown &quot;</span></div>
<div class="line">                              + <span class="stringliteral">&quot;approval value: %1&quot;</span>).arg(field[0]));</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    params.amount     = _transactions.currentItem().rawValue(<span class="stringliteral">&quot;ccpay_amount&quot;</span>);</div>
<div class="line">    params.ccpay_id   = _transactions.id;</div>
<div class="line">    params.currid     = _currid;</div>
<div class="line">    params.status     = <span class="stringliteral">&quot;V&quot;</span>;</div>
<div class="line">    params.auth_charge= <span class="stringliteral">&quot;V&quot;</span>;</div>
<div class="line">    params.type       = <span class="stringliteral">&quot;V&quot;</span>;</div>
<div class="line">    params.reforder   = _transactions.column(<span class="stringliteral">&quot;docnumber&quot;</span>).text;</div>
<div class="line">    params.avs        = field[5];</div>
<div class="line">    params.ordernum   = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    params.xactionid  = field[6];</div>
<div class="line">    params.code       = field[4];</div>
<div class="line">    params.shipping   = field[34];</div>
<div class="line">    params.tax        = field[32];</div>
<div class="line">    params.ref        = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    params.message    = field[5];</div>
<div class="line">    params.auth       = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// report the result</span></div>
<div class="line">    var ccq = toolbox.executeQuery( </div>
<div class="line">             <span class="stringliteral">&#39;UPDATE ccpay SET&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;fromcurr&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;      ccpay_amount=ROUND(currToCurr(&lt;? value(&quot;fromcurr&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;                                    &lt;? value(&quot;tocurr&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;                                    &lt;? value(&quot;amount&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;                                    CURRENT_DATE), 2),&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_curr_id=&lt;? value(&quot;currid&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? else ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_amount=ROUND(&lt;? value(&quot;amount&quot;) ?&gt;, 2),&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_curr_id=&lt;? value(&quot;currid&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_auth=&lt;? value(&quot;auth&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_approved=&lt;? value(&quot;approved&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_avs=&lt;? value(&quot;avs&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_code=&lt;? value(&quot;code&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_error=&lt;? value(&quot;error&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_message=&lt;? value(&quot;message&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_ordernum=&lt;? value(&quot;ordernum&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_ref=&lt;? value(&quot;ref&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;shipping&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_shipping=&lt;? value(&quot;shipping&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;score&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_yp_r_score=&lt;? value(&quot;score&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;tax&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_r_tax=&lt;? value(&quot;tax&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;tdate&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_yp_r_tdate=&lt;? value(&quot;tdate&quot;) ?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? if exists(&quot;time&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_yp_r_time=&lt;? value(&quot;time&quot;)?&gt;,&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;&lt;? endif ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39;       ccpay_status=&lt;? value(&quot;status&quot;) ?&gt;&#39;</span></div>
<div class="line">           + <span class="stringliteral">&#39; WHERE (ccpay_id=&lt;? value(&quot;ccpay_id&quot;) ?&gt;);&#39;</span>,</div>
<div class="line">           params);</div>
<div class="line">    <span class="keywordflow">if</span> (ccq.lastError().type &gt; 0)</div>
<div class="line">    {</div>
<div class="line">      QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Query Failed&quot;</span>),</div>
<div class="line">                         qsTr(<span class="stringliteral">&quot;There was an error querying the database: %1&quot;</span>)</div>
<div class="line">                         .arg(ccq.lastError().text));</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    QMessageBox.information(mywindow, qsTr(<span class="stringliteral">&quot;Transaction Complete&quot;</span>),</div>
<div class="line">                       qsTr(<span class="stringliteral">&quot;&lt;p&gt;The ccpay table has been updated after &quot;</span></div>
<div class="line">                          + <span class="stringliteral">&quot;completing the Void transaction.&quot;</span>));</div>
<div class="line">    sPopulateTransactions();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> (e)</div>
<div class="line">  {</div>
<div class="line">    print(<span class="stringliteral">&quot;sHandleResponse exception at &quot;</span> + e.lineNumber + <span class="stringliteral">&quot;: &quot;</span> + e);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">finally</span></div>
<div class="line">  {  <span class="comment">// allow the user to process another</span></div>
<div class="line">    print(<span class="stringliteral">&quot;sHandleResponse entered finally block&quot;</span>);</div>
<div class="line">    _transactions.enabled = <span class="keyword">true</span>;</div>
<div class="line">    _void.enabled         = (_transactions.id != -1);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> sError(neterror)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">  {</div>
<div class="line">    _error = <span class="keyword">true</span>;</div>
<div class="line">    QMessageBox.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error during data transfer&quot;</span>),</div>
<div class="line">                   qsTr(<span class="stringliteral">&quot;&lt;p&gt;There was a network error trying to post the &quot;</span></div>
<div class="line">                      + <span class="stringliteral">&quot;transaction: %1.&quot;</span></div>
<div class="line">                      + <span class="stringliteral">&quot;Look up this error code at &quot;</span></div>
<div class="line">                      + <span class="stringliteral">&quot; &lt;a&gt;http://doc.trolltech.com/4.4/qnetworkreply.html&quot;</span></div>
<div class="line">                      + <span class="stringliteral">&quot;#NetworkError-enum&lt;/a&gt;&quot;</span>).arg(neterror.toString());</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> (e)</div>
<div class="line">  {</div>
<div class="line">    print(<span class="stringliteral">&quot;sError - exception at line &quot;</span> + e.lineNumber + <span class="stringliteral">&quot;: &quot;</span></div>
<div class="line">        + e);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">sPopulateTransactions();</div>
</div><!-- fragment --> </div><!-- contents -->
  <hr size="1">
  <table width="100%">
    <tr>
      <td width="33%" style="text-align: left;"> Generated on Mon May 3 2021 </td>
      <td width="34%" style="text-align: center;"> xTuple ERP Programmer Reference, Version 4.12.0 </td>
      <td width="33%" style="text-align: right;">
        <a href="http://www.doxygen.org/index.html">
          <img src="doxygen.png" alt="doxygen" align="middle" border="0">
        </a> 1.8.17</address>
      </td>
    </tr>
  </table>
</body>
</html>
